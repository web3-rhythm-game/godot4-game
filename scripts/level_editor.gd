extends Node2D

const in_edit_mode: bool = false
var current_level_name:String = "Sample_Beat"

var fk_fall_time:float = 2.15
var fk_output_arr = [[], [], [], []]

var level_info = {
	"Sample_Beat" = {
		"chart_str": "[[8.02599964141846, 10.5219999313354, 13.0286670684814, 13.6793333053589, 15.6206661224365, 16.2393337249756, 16.879333114624, 17.4766670227051, 18.0740009307861, 28.0793338775635, 35.0980010986328, 36.9860015869141, 38.2553344726563, 41.6793342590332, 44.8046661376953, 46.3726669311523, 47.3220001220703, 48.2926651000977, 50.1593338012695, 56.4526649475098, 57.391332244873, 58.9486671447754, 67.7486663818359], [2.98066673278809, 5.49799976348877, 19.7060009002686, 20.324666595459, 20.6553340911865, 24.0260005950928, 25.6046672821045, 27.7700000762939, 32.1966682434082, 35.7059989929199, 37.6260009765625, 40.1006675720215, 40.7513328552246, 42.6393333435059, 46.7033325195313, 47.6526657104492, 48.8900009155273, 49.85, 50.4793334960938, 50.8099990844727, 51.7380004882813, 52.6766677856445, 54.2766662597656, 55.8446670532227, 57.0926681518555, 57.7220016479492, 58.340665435791, 59.5886665344238, 60.857999420166, 63.3539978027344], [18.6926666259766, 20.0473323822022, 23.0766674041748, 25.5939994812012, 26.5540004730225, 27.4819999694824, 27.791333770752, 30.6393333435059, 32.5593315124512, 33.85, 35.7486663818359, 36.3459983825684, 37.0073333740234, 37.9566665649414, 38.5753341674805, 39.1726661682129, 39.8019996643066, 41.359334564209, 43.3006683349609, 45.1779991149902, 47.4499984741211, 48.2926651000977, 49.5726676940918, 50.4899993896484, 50.842000579834, 51.7380004882813, 56.7726684570313, 57.4019981384277, 58.340665435791, 60.857999420166, 63.386003112793], [18.1060005187988, 20.6766658782959, 24.0366664886475, 26.0846668243408, 27.0873332977295, 33.1993347167969, 34.4580017089844, 36.0259986877441, 36.6553321838379, 37.3273330688477, 38.2980018615723, 38.873998260498, 42.3299995422363, 44.2073341369629, 45.7966667175293, 47.9726654052734, 48.900666809082, 50.1593338012695, 51.1299987792969, 51.4713340759277, 52.0259986877441, 52.3566680908203, 56.1540008544922, 57.1033340454102, 58.0206657409668, 60.239331817627, 60.5593315124512, 61.8713317871094, 62.4899993896484, 63.1193328857422, 63.9939971923828, 64.7086654663086, 65.2740036010742]]",
		"music": load("res://assets/Music/1Min_Sample_Beat.wav")
	}
}

func _ready() -> void:

	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()

	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	
	else:
		var chart_obj = level_info.get(current_level_name).get("chart_str")
		var chart_arr = str_to_var(chart_obj)
		
		var counter:int = 0
		for key in chart_arr:
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_D"
				1:
					button_name = "button_F"
				2:
					button_name = "button_J"
				3:
					button_name = "button_K"
			for delay in key:
				SpawnFallingKey(button_name, delay)
				
			counter += 1
		
func KeyListenerPress(button_name: String, array_num: int):
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished() -> void:
	get_tree().change_scene_to_file("res://scenes/game_end.tscn")
	if(in_edit_mode):
		print(fk_output_arr)
